FROM ubuntu:18.04
# MAINTAINER binbiriz

RUN apt-get update
RUN DEBIAN_FRONTEND=noninteractive apt-get upgrade --yes
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y software-properties-common git curl wget rsync
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y unrar-free p7zip-full p7zip-rar unzip
RUN add-apt-repository ppa:ondrej/php
RUN apt-get update
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y apache2 apache2-utils php7.4 libapache2-mod-php7.4
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y php7.4-cli php7.4-common php7.4-mbstring php7.4-zip
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y php7.4-xml php7.4-curl php7.4-bcmath php7.4-gd
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y php7.4-mysql php7.4-opcache php7.4-apcu php7.4-pcov
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y php7.4-intl php7.4-sqlite php7.4-uploadprogress

RUN a2enmod http2 expires headers deflate rewrite include php7.4

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y php7.4-fpm
RUN a2enmod proxy_fcgi setenvif
RUN a2enconf php7.4-fpm
RUN a2dismod php7.4 mpm_prefork
RUN a2enmod mpm_event

# Purge any other php versions if any
RUN DEBIAN_FRONTEND=noninteractive apt-get remove --yes --purge php7.0*
RUN DEBIAN_FRONTEND=noninteractive apt-get remove --yes --purge php7.1*
RUN DEBIAN_FRONTEND=noninteractive apt-get remove --yes --purge php7.2*
RUN DEBIAN_FRONTEND=noninteractive apt-get remove --yes --purge php7.3*
RUN DEBIAN_FRONTEND=noninteractive apt-get remove --yes --purge php8.0*
RUN DEBIAN_FRONTEND=noninteractive apt-get remove --yes --purge php8.1*
RUN DEBIAN_FRONTEND=noninteractive apt-get autoremove --yes
RUN DEBIAN_FRONTEND=noninteractive apt-get autoclean --yes

COPY apache2.conf /bin/
COPY init_container.sh /bin/
COPY index.php /home/site/wwwroot/index.php

RUN   \
   rm -f /var/log/apache2/* \
   && rmdir /var/lock/apache2 \
   && rmdir /var/run/apache2 \
   && rmdir /var/log/apache2 \
   && chmod 777 /var/log \
   && chmod 777 /var/run \
   && chmod 777 /var/lock \
   && chmod 777 /bin/init_container.sh \
   && cp /bin/apache2.conf /etc/apache2/apache2.conf \
   && rm -rf /var/www/html \
   && rm -rf /var/log/apache2 \
   && mkdir -p /home/LogFiles \
   && ln -s /home/site/wwwroot /var/www/html \
   && ln -s /home/LogFiles /var/log/apache2


# RUN { \
#                 echo 'opcache.memory_consumption=128'; \
#                 echo 'opcache.interned_strings_buffer=8'; \
#                 echo 'opcache.max_accelerated_files=4000'; \
#                 echo 'opcache.revalidate_freq=60'; \
#                 echo 'opcache.fast_shutdown=1'; \
#                 echo 'opcache.enable_cli=1'; \
#     } > /usr/local/etc/php/conf.d/opcache-recommended.ini

# RUN { \
#                 echo 'error_log=/var/log/apache2/php-error.log'; \
#                 echo 'display_errors=Off'; \
#                 echo 'log_errors=On'; \
#                 echo 'display_startup_errors=Off'; \
#                 echo 'date.timezone=UTC'; \
#     } > /usr/local/etc/php/conf.d/php.ini

COPY sshd_config /etc/ssh/

EXPOSE 2222 8080

ENV APACHE_RUN_USER www-data
ENV PHP_VERSION $(php -r 'echo PHP_VERSION;')

ENV PORT 8080
ENV WEBSITE_ROLE_INSTANCE_ID localRoleInstance
ENV WEBSITE_INSTANCE_ID localInstance
ENV PATH ${PATH}:/home/site/wwwroot

WORKDIR /var/www/html

ENTRYPOINT ["/bin/init_container.sh"]
